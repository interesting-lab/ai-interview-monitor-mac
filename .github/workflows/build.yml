name: macOS Build & Package

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    env:
      # å¯é€‰ï¼šåœ¨ä»“åº“ Secrets ä¸­é…ç½®ä»¥ä¸‹å˜é‡ä»¥å¯ç”¨ç¨³å®šç­¾å
      # CODESIGN_P12_BASE64: è‡ªç­¾/å¼€å‘è€…è¯ä¹¦çš„ .p12ï¼ˆBase64ï¼‰
      # CODESIGN_P12_PASSWORD: è¯¥ .p12 çš„å¯†ç 
      # CODESIGN_ID: è¯ä¹¦åï¼ˆå¦‚ "My Local Dev" æˆ– "Developer ID Application: XXX"ï¼‰
      # ï¼ˆå¦‚æœªæä¾›åˆ™ fallback ä¸ºä¸´æ—¶ç­¾åï¼‰
      CODESIGN_P12_BASE64: ${{ secrets.CODESIGN_P12_BASE64 }}
      CODESIGN_P12_PASSWORD: ${{ secrets.CODESIGN_P12_PASSWORD }}
      CODESIGN_ID: ${{ secrets.CODESIGN_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Show Swift toolchain
        run: swift --version

      - name: Import code signing certificate (optional)
        if: ${{ env.CODESIGN_P12_BASE64 != '' }}
        run: |
          set -e
          echo "ðŸ” Importing provided code-sign certificate"
          echo "$CODESIGN_P12_BASE64" | base64 --decode > signing.p12
          KEYCHAIN_PATH="$RUNNER_TEMP/codesign.keychain-db"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security import signing.p12 -k "$KEYCHAIN_PATH" -P "$CODESIGN_P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN_PATH"
          IDENT=$(security find-identity -p codesigning -v "$KEYCHAIN_PATH" | head -1 | awk -F\" '{print $2}')
          echo "CODESIGN_ID=${CODESIGN_ID:-$IDENT}" >> "$GITHUB_ENV"
          echo "CODESIGN_KEYCHAIN=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "âœ… Imported identity: ${CODESIGN_ID:-$IDENT}"

      - name: Build app and DMG
        run: |
          chmod +x build_app.sh
          ./build_app.sh

      - name: Upload app bundle
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle
          path: "æ‹¾é—®AIåŠ©æ‰‹-monitor.app"

      - name: Upload DMG installer
        uses: actions/upload-artifact@v4
        with:
          name: installer-dmg
          path: "æ‹¾é—®AIåŠ©æ‰‹-monitor.dmg"

