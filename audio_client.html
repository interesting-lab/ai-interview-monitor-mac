<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘æ•°æ®æµ - å®æ—¶ç›‘æ§</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .control-panel {
            text-align: center;
            margin-bottom: 40px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin: 0 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.connected {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .btn.disconnect {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }

        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .status-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .status-card.connected {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .status-card.disconnected {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }

        .status-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .status-card .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .audio-visualizer {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .audio-visualizer h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5rem;
        }

        .waveform {
            width: 100%;
            height: 150px;
            background: #fff;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .waveform canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .audio-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-item .label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .log-panel {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .log-entry.info {
            background: rgba(66, 153, 225, 0.2);
        }

        .log-entry.success {
            background: rgba(72, 187, 120, 0.2);
        }

        .log-entry.error {
            background: rgba(245, 101, 101, 0.2);
        }

        .log-entry.audio {
            background: rgba(159, 122, 234, 0.2);
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .status-panel {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸµ éŸ³é¢‘æ•°æ®æµç›‘æ§</h1>
            <p>å®æ—¶éŸ³é¢‘æ•°æ®å¯è§†åŒ–ä¸ç›‘æ§ç³»ç»Ÿ</p>
        </div>

        <div class="content">
            <div class="control-panel">
                <button id="connectBtn" class="btn">è¿æ¥æœåŠ¡å™¨</button>
                <button id="disconnectBtn" class="btn disconnect" disabled>æ–­å¼€è¿æ¥</button>
            </div>

            <div class="status-panel">
                <div class="status-card" id="connectionStatus">
                    <h3>è¿æ¥çŠ¶æ€</h3>
                    <div class="value" id="connectionText">æœªè¿æ¥</div>
                </div>
                <div class="status-card">
                    <h3>éº¦å…‹é£æ•°æ®åŒ…</h3>
                    <div class="value" id="micPackets">0</div>
                </div>
                <div class="status-card">
                    <h3>ç³»ç»ŸéŸ³é¢‘æ•°æ®åŒ…</h3>
                    <div class="value" id="systemPackets">0</div>
                </div>
                <div class="status-card">
                    <h3>è¿æ¥æ—¶é•¿</h3>
                    <div class="value" id="connectionTime">00:00</div>
                </div>
            </div>

            <div class="audio-visualizer">
                <h3>ğŸ¤ éº¦å…‹é£éŸ³é¢‘æ³¢å½¢</h3>
                <div class="waveform">
                    <canvas id="micCanvas" width="800" height="150"></canvas>
                </div>
                <div class="audio-stats">
                    <div class="stat-item">
                        <div class="label">å½“å‰éŸ³é‡</div>
                        <div class="value" id="micVolume">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">å³°å€¼éŸ³é‡</div>
                        <div class="value" id="micPeak">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">æ ·æœ¬æ•°</div>
                        <div class="value" id="micSamples">0</div>
                    </div>
                </div>
            </div>

            <div class="audio-visualizer">
                <h3>ğŸ”Š ç³»ç»ŸéŸ³é¢‘æ³¢å½¢</h3>
                <div class="waveform">
                    <canvas id="systemCanvas" width="800" height="150"></canvas>
                </div>
                <div class="audio-stats">
                    <div class="stat-item">
                        <div class="label">å½“å‰éŸ³é‡</div>
                        <div class="value" id="systemVolume">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">å³°å€¼éŸ³é‡</div>
                        <div class="value" id="systemPeak">0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">æ ·æœ¬æ•°</div>
                        <div class="value" id="systemSamples">0</div>
                    </div>
                </div>
            </div>

            <div class="audio-visualizer">
                <h3>ğŸ“Š ç³»ç»Ÿæ—¥å¿—</h3>
                <div class="log-panel" id="logPanel">
                    <div class="log-entry info">ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡è¿æ¥...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocketè¿æ¥
        let ws = null;
        let isConnected = false;
        let connectionStartTime = null;
        let connectionTimer = null;
        
        // ç»Ÿè®¡æ•°æ®
        let stats = {
            micPackets: 0,
            systemPackets: 0,
            micPeak: 0,
            systemPeak: 0
        };

        // Canvasä¸Šä¸‹æ–‡
        const micCanvas = document.getElementById('micCanvas');
        const systemCanvas = document.getElementById('systemCanvas');
        const micCtx = micCanvas.getContext('2d');
        const systemCtx = systemCanvas.getContext('2d');

        // DOMå…ƒç´ 
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const logPanel = document.getElementById('logPanel');

        // äº‹ä»¶ç›‘å¬å™¨
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);

        function connect() {
            if (isConnected) return;

            log('æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨...', 'info');
            
            try {
                // è·å–å½“å‰ä¸»æœºåå’Œç«¯å£
                const currentHost = window.location.hostname || 'localhost';
                
                // æ ¹æ®å½“å‰åè®®å†³å®šä½¿ç”¨WSè¿˜æ˜¯WSS
                const isSecure = window.location.protocol === 'https:';
                const wsProtocol = isSecure ? 'wss://' : 'ws://';
                const wsPort = isSecure ? '9048' : '9047';
                
                // åˆ›å»ºWebSocketè¿æ¥
                ws = new WebSocket(`${wsProtocol}${currentHost}:${wsPort}/ws`);
                log(`ğŸ”Œ æ­£åœ¨è¿æ¥åˆ° ${wsProtocol}${currentHost}:${wsPort}/ws`, 'info');
                
                ws.onopen = function(event) {
                    isConnected = true;
                    connectionStartTime = Date.now();
                    updateConnectionStatus(true);
                    startConnectionTimer();
                    log('âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨', 'success');
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleMessage(data);
                    } catch (e) {
                        log('âš ï¸ æ¶ˆæ¯è§£æé”™è¯¯: ' + e.message, 'error');
                    }
                };

                ws.onclose = function(event) {
                    isConnected = false;
                    updateConnectionStatus(false);
                    stopConnectionTimer();
                    log('âŒ è¿æ¥å·²æ–­å¼€', 'error');
                };

                ws.onerror = function(error) {
                    log('âŒ è¿æ¥é”™è¯¯: ' + error, 'error');
                };

            } catch (error) {
                log('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        function disconnect() {
            if (!isConnected || !ws) return;

            ws.close();
            isConnected = false;
            updateConnectionStatus(false);
            stopConnectionTimer();
            log('ğŸ”Œ å·²ä¸»åŠ¨æ–­å¼€è¿æ¥', 'info');
        }

        function handleMessage(data) {
            if (data.wsEventType === 'audio-data-event') {
                const audioType = data.payload.audioType;
                const audioData = data.payload.data;
                
                if (audioType === 'mic') {
                    stats.micPackets++;
                    document.getElementById('micPackets').textContent = stats.micPackets;
                    drawWaveform(micCtx, audioData, '#4facfe');
                    updateAudioStats('mic', audioData);
                    log(`ğŸ¤ æ”¶åˆ°éº¦å…‹é£æ•°æ®: ${audioData.length} æ ·æœ¬`, 'audio');
                } else if (audioType === 'system') {
                    stats.systemPackets++;
                    document.getElementById('systemPackets').textContent = stats.systemPackets;
                    drawWaveform(systemCtx, audioData, '#56ab2f');
                    updateAudioStats('system', audioData);
                    log(`ğŸ”Š æ”¶åˆ°ç³»ç»ŸéŸ³é¢‘æ•°æ®: ${audioData.length} æ ·æœ¬`, 'audio');
                }
            }
        }

        function drawWaveform(ctx, audioData, color) {
            const canvas = ctx.canvas;
            const width = canvas.width;
            const height = canvas.height;
            
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);
            
            // è®¾ç½®æ ·å¼
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            // ç»˜åˆ¶æ³¢å½¢
            ctx.beginPath();
            const sliceWidth = width / audioData.length;
            let x = 0;
            
            for (let i = 0; i < audioData.length; i++) {
                const v = audioData[i];
                const y = (v + 1) * height / 2; // å°†-1åˆ°1æ˜ å°„åˆ°0åˆ°height
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.stroke();
            
            // ç»˜åˆ¶ä¸­çº¿
            ctx.strokeStyle = '#e9ecef';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, height / 2);
            ctx.lineTo(width, height / 2);
            ctx.stroke();
        }

        function updateAudioStats(type, audioData) {
            const rms = Math.sqrt(audioData.reduce((sum, sample) => sum + sample * sample, 0) / audioData.length);
            const peak = Math.max(...audioData.map(Math.abs));
            
            if (type === 'mic') {
                document.getElementById('micVolume').textContent = rms.toFixed(3);
                document.getElementById('micSamples').textContent = audioData.length;
                if (peak > stats.micPeak) {
                    stats.micPeak = peak;
                    document.getElementById('micPeak').textContent = peak.toFixed(3);
                }
            } else if (type === 'system') {
                document.getElementById('systemVolume').textContent = rms.toFixed(3);
                document.getElementById('systemSamples').textContent = audioData.length;
                if (peak > stats.systemPeak) {
                    stats.systemPeak = peak;
                    document.getElementById('systemPeak').textContent = peak.toFixed(3);
                }
            }
        }

        function updateConnectionStatus(connected) {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            
            if (connected) {
                connectionStatus.className = 'status-card connected';
                connectionText.textContent = 'å·²è¿æ¥';
            } else {
                connectionStatus.className = 'status-card disconnected';
                connectionText.textContent = 'æœªè¿æ¥';
            }
        }

        function startConnectionTimer() {
            connectionTimer = setInterval(() => {
                if (connectionStartTime) {
                    const elapsed = Date.now() - connectionStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    document.getElementById('connectionTime').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopConnectionTimer() {
            if (connectionTimer) {
                clearInterval(connectionTimer);
                connectionTimer = null;
                document.getElementById('connectionTime').textContent = '00:00';
            }
        }

        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
            while (logPanel.children.length > 100) {
                logPanel.removeChild(logPanel.firstChild);
            }
        }

        // åˆå§‹åŒ–Canvaså°ºå¯¸
        function resizeCanvas() {
            const canvases = [micCanvas, systemCanvas];
            canvases.forEach(canvas => {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * 2; // é«˜DPIæ˜¾ç¤º
                canvas.height = rect.height * 2;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
                canvas.getContext('2d').scale(2, 2);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            resizeCanvas();
            log('ğŸµ éŸ³é¢‘ç›‘æ§ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª', 'success');
        });

        window.addEventListener('resize', resizeCanvas);
    </script>
</body>
</html> 