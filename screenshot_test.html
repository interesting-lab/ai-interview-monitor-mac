<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆªå›¾åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status.disconnected {
            background: #fee;
            color: #c53030;
            border: 1px solid #fed7d7;
        }
        
        .status.connected {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #c6f6d5;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .connect-btn {
            background: #4299e1;
            color: white;
        }
        
        .connect-btn:hover {
            background: #3182ce;
        }
        
        .disconnect-btn {
            background: #e53e3e;
            color: white;
        }
        
        .disconnect-btn:hover {
            background: #c53030;
        }
        
        .screenshot-btn {
            background: #38a169;
            color: white;
        }
        
        .screenshot-btn:hover {
            background: #2f855a;
        }
        
        .screenshot-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .screenshot-container {
            margin-top: 30px;
            text-align: center;
        }
        
        .screenshot-container img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .log {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.info { color: #63b3ed; }
        .log-entry.success { color: #68d391; }
        .log-entry.error { color: #fc8181; }
        .log-entry.screenshot { color: #d6bcfa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¸ æˆªå›¾åŠŸèƒ½æµ‹è¯•</h1>
        
        <div id="status" class="status disconnected">
            âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨
        </div>
        
        <div class="controls">
            <button id="connectBtn" class="connect-btn">è¿æ¥æœåŠ¡å™¨</button>
            <button id="disconnectBtn" class="disconnect-btn" style="display: none;">æ–­å¼€è¿æ¥</button>
            <button id="screenshotBtn" class="screenshot-btn" disabled>ğŸ“¸ æˆªå›¾</button>
        </div>
        
        <div class="screenshot-container" id="screenshotContainer" style="display: none;">
            <h3>æœ€æ–°æˆªå›¾:</h3>
            <img id="screenshotImg" src="" alt="æˆªå›¾">
        </div>
        
        <div class="log" id="log">
            <div class="log-entry info">ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡è¿æ¥...</div>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const screenshotBtn = document.getElementById('screenshotBtn');
        const screenshotContainer = document.getElementById('screenshotContainer');
        const screenshotImg = document.getElementById('screenshotImg');
        const logEl = document.getElementById('log');
        
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        screenshotBtn.addEventListener('click', takeScreenshot);
        
        function connect() {
            if (isConnected) return;
            
            log('æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨...', 'info');
            
            try {
                // è·å–å½“å‰ä¸»æœºåå’Œç«¯å£
                const currentHost = window.location.hostname || 'localhost';
                
                // æ ¹æ®å½“å‰åè®®å†³å®šä½¿ç”¨WSè¿˜æ˜¯WSS
                const isSecure = window.location.protocol === 'https:';
                const wsProtocol = isSecure ? 'wss://' : 'ws://';
                const wsPort = isSecure ? '9048' : '9047';
                
                // åˆ›å»ºWebSocketè¿æ¥
                ws = new WebSocket(`${wsProtocol}${currentHost}:${wsPort}/ws`);
                log(`ğŸ”Œ æ­£åœ¨è¿æ¥åˆ° ${wsProtocol}${currentHost}:${wsPort}/ws`, 'info');
                
                ws.onopen = function(event) {
                    isConnected = true;
                    updateUI();
                    log('âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨', 'success');
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleMessage(data);
                    } catch (e) {
                        log('æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯: ' + event.data, 'info');
                    }
                };
                
                ws.onclose = function(event) {
                    isConnected = false;
                    updateUI();
                    log('âŒ è¿æ¥å·²æ–­å¼€', 'error');
                };
                
                ws.onerror = function(error) {
                    log('âŒ è¿æ¥é”™è¯¯', 'error');
                };
                
            } catch (error) {
                log('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function disconnect() {
            if (!isConnected || !ws) return;
            
            ws.close();
            isConnected = false;
            updateUI();
            log('ğŸ”Œ å·²ä¸»åŠ¨æ–­å¼€è¿æ¥', 'info');
        }
        
        function takeScreenshot() {
            if (!isConnected || !ws) return;
            
            const command = {
                type: "client-screenshot-command",
                wsEventType: "client-screenshot-command",
                payload: "",
                id: generateId()
            };
            
            log('ğŸ“¸ å‘é€æˆªå›¾å‘½ä»¤ï¼ŒID: ' + command.id, 'screenshot');
            ws.send(JSON.stringify(command));
        }
        
        function handleMessage(data) {
            if (data.wsEventType === 'clipboard-image-event') {
                log('ğŸ“¸ æ”¶åˆ°æˆªå›¾æ•°æ®ï¼ŒID: ' + data.id, 'screenshot');
                
                if (data.payload && data.payload.base64) {
                    screenshotImg.src = data.payload.base64;
                    screenshotContainer.style.display = 'block';
                    log('âœ… æˆªå›¾æ˜¾ç¤ºæˆåŠŸ', 'success');
                } else {
                    log('âŒ æˆªå›¾æ•°æ®æ ¼å¼é”™è¯¯', 'error');
                }
            } else if (data.wsEventType === 'audio-data-event') {
                // å¿½ç•¥éŸ³é¢‘æ•°æ®ï¼Œé¿å…æ—¥å¿—è¿‡å¤š
            } else {
                log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(data), 'info');
            }
        }
        
        function updateUI() {
            if (isConnected) {
                statusEl.textContent = 'âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨';
                statusEl.className = 'status connected';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'inline-block';
                screenshotBtn.disabled = false;
            } else {
                statusEl.textContent = 'âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨';
                statusEl.className = 'status disconnected';
                connectBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'none';
                screenshotBtn.disabled = true;
            }
        }
        
        function generateId() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 21; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }
        
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.firstChild);
            }
        }
    </script>
</body>
</html> 